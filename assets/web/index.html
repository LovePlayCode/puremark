<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PureMark Preview</title>
  <link rel="stylesheet" href="markdown.css">
</head>
<body>
  <div id="content"></div>
  
  <script>
    /**
     * PureMark Markdown 渲染器
     * 
     * 功能：
     * - 解析 Markdown 并转换为 HTML
     * - 提取大纲标题
     * - 处理链接点击
     * - 支持滚动到指定标题
     */
    
    // 转义 HTML 特殊字符
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 生成标题 ID
    function generateHeadingId(text) {
      return text.toLowerCase()
        .replace(/[^a-z0-9\u4e00-\u9fa5]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }
    
    // 简单的 Markdown 解析器
    function parseMarkdown(text) {
      if (!text) return '';
      
      let html = text;
      
      // 代码块 (先处理以避免内部内容被其他规则处理)
      html = html.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
        return '<pre><code class="language-' + lang + '">' + escapeHtml(code.trim()) + '</code></pre>';
      });
      
      // 行内代码
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // 标题 (同时生成 ID)
      html = html.replace(/^#{6}\s+(.*)$/gm, function(match, text) {
        const id = generateHeadingId(text);
        return '<h6 id="' + id + '">' + text + '</h6>';
      });
      html = html.replace(/^#{5}\s+(.*)$/gm, function(match, text) {
        const id = generateHeadingId(text);
        return '<h5 id="' + id + '">' + text + '</h5>';
      });
      html = html.replace(/^#{4}\s+(.*)$/gm, function(match, text) {
        const id = generateHeadingId(text);
        return '<h4 id="' + id + '">' + text + '</h4>';
      });
      html = html.replace(/^#{3}\s+(.*)$/gm, function(match, text) {
        const id = generateHeadingId(text);
        return '<h3 id="' + id + '">' + text + '</h3>';
      });
      html = html.replace(/^#{2}\s+(.*)$/gm, function(match, text) {
        const id = generateHeadingId(text);
        return '<h2 id="' + id + '">' + text + '</h2>';
      });
      html = html.replace(/^#{1}\s+(.*)$/gm, function(match, text) {
        const id = generateHeadingId(text);
        return '<h1 id="' + id + '">' + text + '</h1>';
      });
      
      // 粗体和斜体
      html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
      html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
      html = html.replace(/_(.+?)_/g, '<em>$1</em>');
      
      // 删除线
      html = html.replace(/~~(.+?)~~/g, '<del>$1</del>');
      
      // 链接
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" onclick="handleLinkClick(event, \'$2\')">$1</a>');
      
      // 图片
      html = html.replace(/!\[([^\]]*?)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
      
      // 引用
      html = html.replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>');
      
      // 水平线
      html = html.replace(/^([-*_]){3,}$/gm, '<hr>');
      
      // 无序列表
      html = html.replace(/^[*\-+]\s+(.*)$/gm, '<li>$1</li>');
      
      // 有序列表
      html = html.replace(/^\d+\.\s+(.*)$/gm, '<li>$1</li>');
      
      // 任务列表
      html = html.replace(/<li>\[x\]\s+(.*)$/gmi, '<li class="task-list-item"><input type="checkbox" checked disabled>$1');
      html = html.replace(/<li>\[ \]\s+(.*)$/gm, '<li class="task-list-item"><input type="checkbox" disabled>$1');
      
      // 段落 (换行)
      html = html.replace(/\n\n/g, '</p><p>');
      html = '<p>' + html + '</p>';
      
      // 清理空段落和标签
      html = html.replace(/<p><\/p>/g, '');
      html = html.replace(/<p>(<h[1-6])/g, '$1');
      html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
      html = html.replace(/<p>(<pre)/g, '$1');
      html = html.replace(/(<\/pre>)<\/p>/g, '$1');
      html = html.replace(/<p>(<blockquote)/g, '$1');
      html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
      html = html.replace(/<p>(<hr>)/g, '$1');
      html = html.replace(/(<hr>)<\/p>/g, '$1');
      html = html.replace(/<p>(<li)/g, '<ul>$1');
      html = html.replace(/(<\/li>)<\/p>/g, '$1</ul>');
      
      return html;
    }
    
    // 更新 Markdown 内容
    function updateMarkdown(content) {
      const contentEl = document.getElementById('content');
      contentEl.innerHTML = parseMarkdown(content);
      extractOutline();
    }
    
    // 提取大纲
    function extractOutline() {
      const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
      const outline = [];
      
      headings.forEach(function(heading) {
        outline.push({
          id: heading.id,
          level: parseInt(heading.tagName.charAt(1)),
          text: heading.textContent
        });
      });
      // 通过 Flutter handler 发送大纲
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('onOutlineGenerated', outline);
      }
    }
    
    // 滚动到指定标题
    function scrollToHeading(headingId) {
      const element = document.getElementById(headingId);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    // 处理链接点击
    function handleLinkClick(event, url) {
      event.preventDefault();
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('onLinkClicked', url);
      }
    }
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('onWebViewReady');
      }
    });
  </script>
</body>
</html>
