# 选中段落弹出菜单（支持复制）— 实现方案（WebView 内实现）

## 目标

用户选中 Markdown 正文中的一段文字后，通过**右键（或辅助点击）**在 **WebView 内**弹出上下文菜单，提供「复制」等操作。菜单样式与 Flutter 应用内 `ContextMenu` 对齐，无 JS↔Flutter 桥接，性能更好。

## 技术选型

- **菜单位置**：在 WebView 内用 HTML/CSS 实现，不调用 Flutter overlay。
- **样式**：复用 Flutter `ContextMenu` 与 `AppColors` 的设计 token（圆角 12px、毛玻璃、提升层背景、菜单项高度 36px、阴影等），通过 CSS 变量与主题同步。
- **复制**：使用 `navigator.clipboard.writeText(selectedText)` 或 `document.execCommand('copy')`，在 WebView 内完成，无需 Flutter。

## 实现步骤

### 1. CSS：菜单样式对齐 Flutter

**文件**：`lib/features/viewer/widgets/webview_container.dart`，`_getCssContent()`

- 在 `:root` 中增加与主题相关的菜单变量（随 `isDarkMode` 注入）：
  - `--selection-menu-bg`：菜单背景（对应 Flutter 的 darkBgElevated/lightBgElevated，alpha 0.8）。
  - `--selection-menu-hover`：菜单项 hover 背景（对应 darkBgSurface/lightBgSurface，alpha 0.5）。
- 新增类：
  - `.selection-menu`：容器，`position: fixed`，`border-radius: 12px`，`min-width: 150px`，`max-width: 250px`，`backdrop-filter: blur(20px)`，`background: var(--selection-menu-bg)`，`box-shadow: 0 8px 20px rgba(0,0,0,0.2)`。
  - `.selection-menu-item`：高度 36px，水平 padding 12px，字体 13px，颜色 `var(--text-primary)`，flex 布局；hover 时 `background: var(--selection-menu-hover)`。
- 在 JS 的 `setTheme()` 中同步更新上述两个 CSS 变量，保证切换主题后新弹出的菜单颜色正确。

### 2. JavaScript：右键监听与菜单逻辑

**文件**：同上，`_getJavaScriptContent()` 的 JS 字符串内

- 在 `#content` 或 `document` 上监听 `contextmenu`。
- 回调中：
  - 用 `window.getSelection().toString().trim()` 取选中文本。
  - 若有选中文本：
    - `event.preventDefault()`，阻止系统默认右键菜单。
    - 若已存在上一次的菜单 DOM，先移除。
    - 创建菜单根节点（如 `div.selection-menu`），`position: fixed`，`left: event.clientX`，`top: event.clientY`；若右侧或下侧超出视口，则调整 `left`/`top` 使菜单完整可见。
    - 插入「复制」菜单项：图标（小 SVG 或 Unicode）+ 文案「复制」，点击时：
      - 使用 `navigator.clipboard.writeText(selectedText)`（或在不支持时回退到 `document.execCommand('copy')`）。
      - 移除菜单 DOM，并取消对 document 的 click 监听。
    - 将菜单挂到 `document.body`，并设置一次 `document` 的 `click` 监听：点击菜单外时移除菜单并移除该监听。
  - 若无选中文本：不处理，保留系统默认右键菜单。

### 3. 图标与文案

- 复制图标：使用与 Flutter `Icons.copy` 相近的 inline SVG（两个重叠矩形），尺寸 16px，颜色 `var(--text-secondary)`。
- 文案：「复制」。

### 4. 可选扩展

后续若增加「全选」「在正文中搜索选中内容」等，只需在 JS 中多创建几个 `.selection-menu-item`，在点击回调里执行对应逻辑（如全选可用 `document.execCommand('selectAll')`；搜索可调用现有 `performSearch(selectedText, ...)` 或通过 `callHandler` 通知 Flutter）。

## 数据流小结

```
用户选中文字 → 右键
  → JS: contextmenu → getSelection().toString() → preventDefault
  → 创建 .selection-menu DOM，定位到 (clientX, clientY)，加入「复制」项
  → 用户点「复制」→ navigator.clipboard.writeText(selectedText) → 移除菜单
  → 用户点菜单外 → 移除菜单
（无 Flutter 桥接）
```

## 设计对齐 Flutter 的要点

| 项目       | Flutter ContextMenu      | WebView 内实现                    |
|------------|--------------------------|-----------------------------------|
| 圆角       | 12                       | border-radius: 12px               |
| 菜单宽     | min 150, max 250         | min-width: 150px; max-width: 250px|
| 毛玻璃     | BackdropFilter blur 20   | backdrop-filter: blur(20px)       |
| 背景       | darkBgElevated 0.8 / lightBgElevated 0.8 | var(--selection-menu-bg)   |
| 阴影       | black 0.2, blur 20, offset (0,8) | box-shadow: 0 8px 20px rgba(0,0,0,0.2) |
| 项高       | 36                       | height: 36px                      |
| 项内边距   | 水平 12                  | padding: 0 12px                   |
| 项 hover   | darkBgSurface 0.5 / lightBgSurface 0.5 | var(--selection-menu-hover) |
| 字体       | 13                       | font-size: 13px                   |
| 图标       | 16, secondary            | 16px, var(--text-secondary)       |

## 测试要点

- 在 macOS 上：选中一段正文，右键弹出菜单，点击「复制」后到其他应用粘贴，内容一致。
- 未选中时右键：不弹出自定义菜单，系统默认菜单可用。
- 菜单位置在光标附近，不超出视口。
- 点击菜单外可关闭菜单。
- 切换明/暗主题后，再次右键弹出菜单，样式与当前主题一致。

## 涉及文件一览

| 文件 | 改动 |
|------|------|
| `lib/features/viewer/widgets/webview_container.dart` | 在 `_getCssContent()` 中增加菜单 CSS 变量与 `.selection-menu` / `.selection-menu-item`；在 `_getJavaScriptContent()` 中增加 contextmenu 监听、菜单 DOM 创建与复制逻辑；在 `setTheme()` 中更新菜单相关 CSS 变量 |
| `learn/选中段落弹出菜单-实现方案.md` | 本文档（WebView 内实现版） |

无需修改 `lib/shared/widgets/context_menu.dart`，无需新增 Flutter handler。
